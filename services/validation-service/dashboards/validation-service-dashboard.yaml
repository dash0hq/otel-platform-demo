apiVersion: perses.dev/v1alpha1
kind: PersesDashboard
metadata:
  labels:
    app.kubernetes.io/name: perses-dashboard
    app.kubernetes.io/instance: validation-service
    app.kubernetes.io/part-of: perses-operator
  name: validation-service
  namespace: default
spec:
  display:
    name: Validation-service
    description: Application metrics for the validation service
  panels:
    requestrate:
      kind: Panel
      spec:
        display:
          name: HTTP Request Rate
          description: Rate of incoming validation requests per second
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            thresholds: {}
            visual:
              areaOpacity: 0.3
              connectNulls: false
              display: line
              lineWidth: 2
              palette:
                mode: auto
              pointRadius: 2.5
            yAxis:
              format:
                decimalPlaces: 2
                unit: reqps
              min: 0
              show: true
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  query: rate(http_server_request_duration_seconds_count{service_name="validation-service"}[5m])
                  seriesNameFormat: Requests/sec
    validationresults:
      kind: Panel
      spec:
        display:
          name: Validation Results
          description: Rate of validation pass vs fail results
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            thresholds: {}
            visual:
              areaOpacity: 0.3
              connectNulls: false
              display: line
              lineWidth: 2
              palette:
                mode: auto
              pointRadius: 2.5
            yAxis:
              format:
                decimalPlaces: 2
                unit: decimal
              min: 0
              show: true
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  query: rate(http_server_request_duration_seconds_count{service_name="validation-service", http_response_status_code="200"}[5m])
                  seriesNameFormat: Valid
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  query: rate(http_server_request_duration_seconds_count{service_name="validation-service", http_response_status_code="400"}[5m])
                  seriesNameFormat: Invalid
    responsetime:
      kind: Panel
      spec:
        display:
          name: Response Time (p95)
          description: 95th percentile response time for validation requests
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            thresholds: {}
            visual:
              areaOpacity: 0
              connectNulls: false
              display: line
              lineWidth: 2
              palette:
                mode: auto
              pointRadius: 2.5
            yAxis:
              format:
                decimalPlaces: 3
                unit: seconds
              min: 0
              show: true
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  query: histogram_quantile(0.95, rate(http_server_request_duration_seconds_bucket{service_name="validation-service"}[5m]))
                  seriesNameFormat: p95 Response Time
    nodejsmemory:
      kind: Panel
      spec:
        display:
          name: Node.js Memory Usage
          description: Node.js process memory usage in bytes
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
            thresholds: {}
            visual:
              areaOpacity: 0
              connectNulls: true
              display: line
              lineWidth: 2
              palette:
                mode: auto
              pointRadius: 2.5
            yAxis:
              format:
                decimalPlaces: 2
                unit: bytes
              min: 0
              show: true
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  query: process_runtime_nodejs_memory_heap_used{service_name="validation-service"}
                  seriesNameFormat: Heap Used
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  query: process_runtime_nodejs_memory_heap_total{service_name="validation-service"}
                  seriesNameFormat: Heap Total
  layouts:
    - kind: Grid
      spec:
        display:
          title: ""
          collapse:
            open: true
        items:
          - x: 0
            "y": 0
            width: 12
            height: 8
            content:
              $ref: "#/spec/panels/requestrate"
          - x: 12
            "y": 0
            width: 12
            height: 8
            content:
              $ref: "#/spec/panels/validationresults"
          - x: 0
            "y": 8
            width: 24
            height: 8
            content:
              $ref: "#/spec/panels/responsetime"
          - x: 0
            "y": 16
            width: 24
            height: 8
            content:
              $ref: "#/spec/panels/nodejsmemory"
  variables: []
  duration: 1h
  refreshInterval: 30s
  datasources: {}
